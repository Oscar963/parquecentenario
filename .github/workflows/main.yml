on:
  push:
    branches:
      - main

name: 🚀 Despliegue Laravel para Parque Centenario

jobs:
  web-deploy:
    name: 🎉 Despliegue Laravel desde GitHub
    runs-on: ubuntu-latest
    steps:
      # 1. Clonar el repositorio en el servidor
      - name: 🚚 Clonar el repositorio en el servidor
        run: |
          sshpass -p "${{ secrets.ftp_password }}" ssh -o StrictHostKeyChecking=no ${{ secrets.ftp_username }}@${{ secrets.ftp_server }} << 'EOF'
          if [ ! -d "${{ secrets.ftp_project_dir }}" ]; then
            git clone https://github.com/Oscar963/parquecentenario.git ${{ secrets.ftp_project_dir }}
          else
            cd ${{ secrets.ftp_project_dir }}
            git reset --hard
            git pull origin main
          fi
          EOF

      # 2. Instalar dependencias y configurar Laravel
      - name: 🛠️ Instalar dependencias y configurar Laravel
        run: |
          sshpass -p "${{ secrets.ftp_password }}" ssh -o StrictHostKeyChecking=no ${{ secrets.ftp_username }}@${{ secrets.ftp_server }} << 'EOF'
          cd ${{ secrets.ftp_project_dir }}
          composer install --no-dev --optimize-autoloader
          cp .env.example .env
          php artisan key:generate
          php artisan config:clear
          php artisan cache:clear
          php artisan config:cache
          EOF

      # 3. Sincronizar la carpeta public con public_html
      - name: 🌐 Sincronizar carpeta public con public_html
        run: |
          sshpass -p "${{ secrets.ftp_password }}" rsync -avz --delete ${{ secrets.ftp_username }}@${{ secrets.ftp_server }}:${{ secrets.ftp_project_dir }}/public/ ${{ secrets.ftp_username }}@${{ secrets.ftp_server }}:/path/to/public_html/
